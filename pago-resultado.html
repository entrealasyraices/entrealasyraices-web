<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Resultado del pago ‚Äì Entre Alas y Ra√≠ces</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Poppins:wght@500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="images/logo-entrealas.jpg" type="image/jpeg">

  <style>
    .success-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      margin-top: 3rem;
      padding: 0 1rem;
    }

    .success-card {
      background: #fff;
      padding: 2rem;
      border-radius: 1.5rem;
      text-align: left;
      max-width: 640px;
      width: 100%;
      box-shadow: 0 6px 18px rgba(0,0,0,0.07);
      border-left: 8px solid #2E7D66;
      animation: fadeIn .7s ease;
    }

    .success-card h1 {
      margin-top: 0;
      color: #2E7D66;
      font-size: 2rem;
      font-family: 'Lora', serif;
      text-align: center;
    }

    .success-card p {
      color: #374151;
      margin-top: .6rem;
      font-size: 1rem;
    }

    .btn {
      display: inline-block;
      margin-top: 1.5rem;
      padding: .9rem 1.5rem;
      background: #2E7D66;
      color: white;
      border-radius: 10px;
      text-decoration: none;
      font-size: 1rem;
    }

    .order-summary {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid #e5e7eb;
      font-size: .95rem;
    }

    .order-summary h2 {
      font-size: 1.2rem;
      margin-bottom: .5rem;
      color: #1f2933;
    }

    .order-item {
      margin-bottom: .4rem;
    }

    .order-item small {
      color: #6b7280;
    }

    .order-totals {
      margin-top: .8rem;
    }

    .order-row {
      display: flex;
      justify-content: space-between;
      margin-top: .25rem;
    }

    .order-row strong {
      font-weight: 600;
    }

    .order-iva {
      margin-top: .4rem;
      font-size: .85rem;
      color: #4b5563;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>

  <script>
    function formatCLP(value) {
      return "$" + Number(value || 0).toLocaleString("es-CL");
    }

    // Obtiene el posible estado de pago desde la URL (?status=APPROVED, etc.)
    function getPaymentStatusFromUrl() {
      try {
        const params = new URLSearchParams(window.location.search);
        const raw =
          params.get("status") ||
          params.get("paymentStatus") ||
          "";
        return raw.toString().trim().toUpperCase();
      } catch {
        return "";
      }
    }

    // ---- Env√≠o de correos usando /api/send-email ----
    async function enviarCorreosPedido(order) {
      // Datos que guardamos en checkout.html
      const rawCheckout = localStorage.getItem("checkoutData");
      const rawCart = localStorage.getItem("cart") || "[]";

      if (!rawCheckout) {
        console.warn("No hay checkoutData en localStorage, no se env√≠an correos.");
        return;
      }

      let datosPedido, carrito;
      try {
        datosPedido = JSON.parse(rawCheckout);
        carrito = JSON.parse(rawCart);
      } catch (err) {
        console.warn("No se pudieron parsear checkoutData/cart:", err);
        return;
      }

      if (!carrito || carrito.length === 0) {
        console.warn("Carrito vac√≠o al intentar enviar correos.");
      }

      const subtotal = carrito.reduce((acc, p) => acc + (p.price || 0) * (p.qty || 1), 0);
      // Si en ear_last_order guardaste shipping/amount/iva, los usamos; si no, ponemos valores por defecto
      const shipping = typeof order.shipping === "number" ? order.shipping : 2990;
      const ivaProducto = typeof order.iva === "number" ? order.iva : Math.round(subtotal * 0.19);
      const total = typeof order.amount === "number" ? order.amount : subtotal + shipping;

      const payload = {
        reference: order.reference || "",
        // datos del formulario de checkout
        ...datosPedido,
        // detalle de compra
        productos: carrito,
        subtotal,
        envio: shipping,
        total,
        ivaProducto
      };

      try {
        const resp = await fetch("/api/send-email", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await resp.json();
        console.log("Respuesta /api/send-email:", data);

        if (data.ok) {
          // Limpiamos carrito y datos de checkout si todo sali√≥ bien
          localStorage.removeItem("cart");
          localStorage.removeItem("checkoutData");
        }
      } catch (err) {
        console.error("Error llamando a /api/send-email:", err);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const tituloEl = document.getElementById("titulo-estado");
      const mensajeEl = document.getElementById("mensaje-estado");

      // 1) Ajustar mensajes seg√∫n posible estado del pago en la URL
      const estado = getPaymentStatusFromUrl();
      console.log("Estado de pago detectado en URL:", estado || "(sin estado)");

      if (estado && tituloEl && mensajeEl) {
        if (estado === "APPROVED") {
          tituloEl.textContent = "¬°Pago realizado con √©xito!";
          mensajeEl.innerHTML = `
            Tu compra fue procesada correctamente. En breve recibir√°s tu
            boleta o factura electr√≥nica en el correo:
            <strong id="correo-cliente"></strong>.
            <br><br>
            Si no ves el cobro reflejado o tienes dudas, escr√≠benos indic√°ndonos tu n√∫mero de pedido.
          `;
        } else if (estado === "REJECTED") {
          tituloEl.textContent = "Tu pago fue rechazado";
          mensajeEl.innerHTML = `
            La transacci√≥n no se complet√≥ exitosamente. Es probable que
            <strong>NO se haya generado ning√∫n cobro</strong>.
            <br><br>
            Puedes intentar nuevamente realizar tu compra o contactar a tu banco
            si el problema persiste. Ante cualquier duda, escr√≠benos indic√°ndonos
            el n√∫mero de pedido para revisar el estado.
          `;
        } else if (estado === "FAILED" || estado === "CANCELED" || estado === "CANCELLED") {
          tituloEl.textContent = "Compra cancelada";
          mensajeEl.innerHTML = `
            El proceso de pago fue cancelado o no pudo completarse correctamente.
            En principio <strong>no deber√≠a haberse generado ning√∫n cobro</strong>.
            <br><br>
            Si deseas, puedes volver a intentar el pago desde la secci√≥n de productos
            o escribirnos para verificar la informaci√≥n de tu intento de compra.
          `;
        } else if (estado === "PENDING") {
          tituloEl.textContent = "Estamos revisando tu pago";
          mensajeEl.innerHTML = `
            Tu transacci√≥n qued√≥ en estado <strong>pendiente</strong>. En cuanto tengamos
            confirmaci√≥n definitiva desde la plataforma de pagos, revisaremos tu pedido
            y te contactaremos al correo:
            <strong id="correo-cliente"></strong>.
            <br><br>
            Si tienes dudas sobre el cobro en tu tarjeta, tambi√©n puedes revisar directamente
            con tu banco.
          `;
        }
        // Si el estado no es uno de los anteriores, se deja el texto por defecto del HTML.
      }

      // 2) Mostrar correo del comprador si existe
      const email = localStorage.getItem("correoComprador");
      if (email) {
        const correoEl = document.getElementById("correo-cliente");
        if (correoEl) correoEl.textContent = email;
      }

      // 3) Mostrar resumen de la √∫ltima orden si existe
      const rawOrder = localStorage.getItem("ear_last_order");
      if (!rawOrder) return;

      let order;
      try {
        order = JSON.parse(rawOrder);
      } catch {
        return;
      }

      const summaryContainer = document.getElementById("order-summary");
      if (!summaryContainer) return;

      const itemsHtml = (order.items || [])
        .map(
          (p) => `
            <div class="order-item">
              <strong>${p.name}</strong> (x${p.qty})<br>
              <small>${formatCLP(p.price)} c/u</small>
            </div>
          `
        )
        .join("");

      summaryContainer.innerHTML = `
        <h2>Resumen de tu pedido</h2>
        <p><strong>N¬∞ de pedido:</strong> ${order.reference || "‚Äî"}</p>

        ${itemsHtml || "<p>No se encontraron productos en el pedido.</p>"}

        <div class="order-totals">
          <div class="order-row">
            <span>Subtotal</span>
            <span>${formatCLP(order.subtotal)}</span>
          </div>
          <div class="order-row">
            <span>Env√≠o</span>
            <span>${formatCLP(order.shipping)}</span>
          </div>
          <div class="order-row">
            <strong>Total</strong>
            <strong>${formatCLP(order.amount)}</strong>
          </div>
        </div>

        <p class="order-iva">
          Incluye IVA (19%) sobre productos: <strong>${formatCLP(order.iva)}</strong>
        </p>
      `;

      // 4) Notificaci√≥n interna (tu correo / registro)
      const notifiedRef = localStorage.getItem("ear_last_order_notified");
      if (order.reference && order.reference !== notifiedRef) {
        try {
          await fetch("/api/order-notify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: rawOrder,
          });
          localStorage.setItem("ear_last_order_notified", order.reference);
        } catch (err) {
          console.warn("No se pudo enviar la notificaci√≥n interna de pedido:", err);
        }
      }

      // 5) Env√≠o de correos al cliente y a ti (usando Gmail /api/send-email)
      const lastEmailRef = localStorage.getItem("ear_last_email_ref");
      if (order.reference && order.reference !== lastEmailRef) {
        await enviarCorreosPedido(order);
        localStorage.setItem("ear_last_email_ref", order.reference);
      }
    });
  </script>
</head>

<body>

<header class="topbar">
  <a href="index.html">
    <img src="images/logo-entrealas.jpg" alt="Entre Alas y Ra√≠ces" style="height:48px;">
  </a>
  <a href="index.html" class="site-slogan">Sanar, sostener y crecer</a>
  <button class="hamburger" aria-label="Abrir men√∫">‚ò∞</button>
</header>

<nav class="navbar menu">
  <a href="index.html">Inicio</a>
  <a href="productos.html">Productos</a>
  <a href="capacitaciones.html">Capacitaciones</a>
  <a href="contacto.html">Contacto</a>
</nav>

<main class="success-container">
  <div class="success-card">
    <h1 id="titulo-estado">Hemos recibido tu intento de pago</h1>

    <p id="mensaje-estado">
      Estamos esperando la confirmaci√≥n definitiva de la plataforma de pagos.
      Si la transacci√≥n fue aprobada, te enviaremos tu boleta o factura
      electr√≥nica dentro de las pr√≥ximas <strong>24‚Äì48 horas h√°biles</strong>
      al correo: <strong id="correo-cliente"></strong>.
    </p>

    <p>
      Si durante el proceso viste un mensaje de error (por ejemplo:
      <em>‚ÄúNo se ha logrado conexi√≥n con el servicio externo‚Äù</em>) o sospechas
      que el pago podr√≠a no haberse realizado, es probable que
      <strong>NO se haya generado ning√∫n cobro</strong>.
    </p>

    <p>
      Ante cualquier duda, escr√≠benos indicando el n√∫mero de pedido que aparece
      m√°s abajo para que podamos revisar el estado directamente con el sistema:
      <br>
      üìß <a href="mailto:ventas@entrealasyraices.cl">ventas@entrealasyraices.cl</a><br>
      üìß <a href="mailto:contacto@entrealasyraices.cl">contacto@entrealasyraices.cl</a>
    </p>

    <div id="order-summary" class="order-summary"></div>

    <a class="btn" href="productos.html">Volver a productos</a>
  </div>
</main>

<footer class="footer">
  <div class="container cols">

    <div class="brand-small">
      <img src="images/logo-entrealas.jpg" alt="Logo Entre Alas y Ra√≠ces">
      <div>
        <strong>Entre Alas y Ra√≠ces SpA</strong><br>
        <small>RUT: 78.224.149-4</small>
      </div>
    </div>

    <div>
      <strong>Legal</strong>
      <p class="mt-3">
        <a href="privacidad.html">Pol√≠tica de Privacidad</a><br>
        <a href="terminos.html">T√©rminos y Condiciones</a><br>
        <a href="envios.html">Env√≠os y Devoluciones</a>
      </p>
    </div>

    <div>
      <strong>Contacto</strong>
      <p class="mt-3">
        <a href="mailto:ventas@entrealasyraices.cl">ventas@entrealasyraices.cl</a><br>
        <a href="mailto:contacto@entrealasyraices.cl">contacto@entrealasyraices.cl</a>
      </p>
    </div>

  </div>
</footer>

</body>
</html>
