<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Pago Exitoso â€“ Entre Alas y RaÃ­ces</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Poppins:wght@500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="images/logo-entrealas.jpg" type="image/jpeg">

  <style>
    .success-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      margin-top: 3rem;
      padding: 0 1rem;
    }

    .success-card {
      background: #fff;
      padding: 2rem;
      border-radius: 1.5rem;
      text-align: left;
      max-width: 640px;
      width: 100%;
      box-shadow: 0 6px 18px rgba(0,0,0,0.07);
      border-left: 8px solid #2E7D66;
      animation: fadeIn .7s ease;
    }

    .success-card h1 {
      margin-top: 0;
      color: #2E7D66;
      font-size: 2rem;
      font-family: 'Lora', serif;
      text-align: center;
    }

    .success-card p {
      color: #374151;
      margin-top: .6rem;
      font-size: 1rem;
    }

    .btn {
      display: inline-block;
      margin-top: 1.5rem;
      padding: .9rem 1.5rem;
      background: #2E7D66;
      color: white;
      border-radius: 10px;
      text-decoration: none;
      font-size: 1rem;
    }

    .order-summary {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid #e5e7eb;
      font-size: .95rem;
    }

    .order-summary h2 {
      font-size: 1.2rem;
      margin-bottom: .5rem;
      color: #1f2933;
    }

    .order-item {
      margin-bottom: .4rem;
    }

    .order-item small {
      color: #6b7280;
    }

    .order-totals {
      margin-top: .8rem;
    }

    .order-row {
      display: flex;
      justify-content: space-between;
      margin-top: .25rem;
    }

    .order-row strong {
      font-weight: 600;
    }

    .order-iva {
      margin-top: .4rem;
      font-size: .85rem;
      color: #4b5563;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>

  <script>
    function formatCLP(value) {
      return "$" + Number(value || 0).toLocaleString("es-CL");
    }

    // ---- EnvÃ­o de correos usando /api/send-email ----
    async function enviarCorreosPedido(order) {
      // Datos que guardamos en checkout.html
      const rawCheckout = localStorage.getItem("checkoutData");
      const rawCart = localStorage.getItem("cart") || "[]";

      if (!rawCheckout) {
        console.warn("No hay checkoutData en localStorage, no se envÃ­an correos.");
        return;
      }

      let datosPedido, carrito;
      try {
        datosPedido = JSON.parse(rawCheckout);
        carrito = JSON.parse(rawCart);
      } catch (err) {
        console.warn("No se pudieron parsear checkoutData/cart:", err);
        return;
      }

      if (!carrito || carrito.length === 0) {
        console.warn("Carrito vacÃ­o al intentar enviar correos.");
      }

      const subtotal = carrito.reduce((acc, p) => acc + (p.price || 0) * (p.qty || 1), 0);
      // Si en ear_last_order guardaste shipping/amount/iva, los usamos; si no, ponemos valores por defecto
      const shipping = typeof order.shipping === "number" ? order.shipping : 2990;
      const ivaProducto = typeof order.iva === "number" ? order.iva : Math.round(subtotal * 0.19);
      const total = typeof order.amount === "number" ? order.amount : subtotal + shipping;

      const payload = {
        reference: order.reference || "",
        // datos del formulario de checkout
        ...datosPedido,
        // detalle de compra
        productos: carrito,
        subtotal,
        envio: shipping,
        total,
        ivaProducto
      };

      try {
        const resp = await fetch("/api/send-email", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await resp.json();
        console.log("Respuesta /api/send-email:", data);

        if (data.ok) {
          // Limpiamos carrito y datos de checkout si todo saliÃ³ bien
          localStorage.removeItem("cart");
          localStorage.removeItem("checkoutData");
        }
      } catch (err) {
        console.error("Error llamando a /api/send-email:", err);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // Mostrar correo del comprador si existe
      const email = localStorage.getItem("correoComprador");
      if (email) {
        const correoEl = document.getElementById("correo-cliente");
        if (correoEl) correoEl.textContent = email;
      }

      // Mostrar resumen de la Ãºltima orden si existe
      const rawOrder = localStorage.getItem("ear_last_order");
      if (!rawOrder) return;

      let order;
      try {
        order = JSON.parse(rawOrder);
      } catch {
        return;
      }

      const summaryContainer = document.getElementById("order-summary");
      if (!summaryContainer) return;

      const itemsHtml = (order.items || [])
        .map(
          (p) => `
            <div class="order-item">
              <strong>${p.name}</strong> (x${p.qty})<br>
              <small>${formatCLP(p.price)} c/u</small>
            </div>
          `
        )
        .join("");

      summaryContainer.innerHTML = `
        <h2>Resumen de tu pedido</h2>
        <p><strong>NÂ° de pedido:</strong> ${order.reference || "â€”"}</p>

        ${itemsHtml || "<p>No se encontraron productos en el pedido.</p>"}

        <div class="order-totals">
          <div class="order-row">
            <span>Subtotal</span>
            <span>${formatCLP(order.subtotal)}</span>
          </div>
          <div class="order-row">
            <span>EnvÃ­o</span>
            <span>${formatCLP(order.shipping)}</span>
          </div>
          <div class="order-row">
            <strong>Total pagado</strong>
            <strong>${formatCLP(order.amount)}</strong>
          </div>
        </div>

        <p class="order-iva">
          Incluye IVA (19%) sobre productos: <strong>${formatCLP(order.iva)}</strong>
        </p>
      `;

      // ----- NotificaciÃ³n interna (tu correo / registro) -----
      const notifiedRef = localStorage.getItem("ear_last_order_notified");
      if (order.reference && order.reference !== notifiedRef) {
        try {
          await fetch("/api/order-notify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: rawOrder,
          });
          localStorage.setItem("ear_last_order_notified", order.reference);
        } catch (err) {
          console.warn("No se pudo enviar la notificaciÃ³n interna de pedido:", err);
        }
      }

      // ----- EnvÃ­o de correos al cliente y a ti (usando Gmail /api/send-email) -----
      const lastEmailRef = localStorage.getItem("ear_last_email_ref");
      if (order.reference && order.reference !== lastEmailRef) {
        await enviarCorreosPedido(order);
        localStorage.setItem("ear_last_email_ref", order.reference);
      }
    });
  </script>
</head>

<body>

<header class="topbar">
  <a href="index.html">
    <img src="images/logo-entrealas.jpg" alt="Entre Alas y RaÃ­ces" style="height:48px;">
  </a>
  <a href="index.html" class="site-slogan">Sanar, sostener y crecer</a>
  <button class="hamburger" aria-label="Abrir menÃº">â˜°</button>
</header>

<nav class="navbar menu">
  <a href="index.html">Inicio</a>
  <a href="productos.html">Productos</a>
  <a href="capacitaciones.html">Capacitaciones</a>
  <a href="contacto.html">Contacto</a>
</nav>

<main class="success-container">
  <div class="success-card">
    <h1>Â¡Gracias por tu compra! ðŸŽ‰</h1>

    <p>Tu pago fue procesado con Ã©xito.</p>

    <p>En un plazo mÃ¡ximo de <strong>24â€“48 horas hÃ¡biles</strong> recibirÃ¡s tu
    <strong>boleta o factura electrÃ³nica</strong> en tu correo:
    <strong id="correo-cliente"></strong></p>

    <p>Si no la recibes, escribe a:<br>
      ðŸ“§ <a href="mailto:ventas@entrealasyraices.cl">ventas@entrealasyraices.cl</a><br>
      ðŸ“§ <a href="mailto:contacto@entrealasyraices.cl">contacto@entrealasyraices.cl</a>
    </p>

    <div id="order-summary" class="order-summary"></div>

    <a class="btn" href="productos.html">Seguir comprando</a>
  </div>
</main>

<footer class="footer">
  <div class="container cols">

    <div class="brand-small">
      <img src="images/logo-entrealas.jpg" alt="Logo Entre Alas y RaÃ­ces">
      <div>
        <strong>Entre Alas y RaÃ­ces SpA</strong><br>
        <small>RUT: 78.224.149-4</small>
      </div>
    </div>

    <div>
      <strong>Legal</strong>
      <p class="mt-3">
        <a href="privacidad.html">PolÃ­tica de Privacidad</a><br>
        <a href="terminos.html">TÃ©rminos y Condiciones</a><br>
        <a href="envios.html">EnvÃ­os y Devoluciones</a>
      </p>
    </div>

    <div>
      <strong>Contacto</strong>
      <p class="mt-3">
        <a href="mailto:ventas@entrealasyraices.cl">ventas@entrealasyraices.cl</a><br>
        <a href="mailto:contacto@entrealasyraices.cl">contacto@entrealasyraices.cl</a>
      </p>
    </div>

  </div>
</footer>

</body>
</html>
